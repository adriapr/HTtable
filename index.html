<!doctype html>
<title>Google spreadsheet to HT-table</title>

<script type="text/javascript">

	function arrayToHTtable(table) {
		var str_output = "[table]<br>";

		for (row of table) {
			str_output += "[tr]";
			for (col of row) {
				str_output += "[td]" + col + "[/td]";
			}
			str_output += "[/tr]<br>";
		}

		str_output += "[/table]";

		return str_output;

		// [table]
		// [tr][td]UE Pa√Øsos Catalans[/td][td]Maurya Pal i Gol[/td][td]0-7[/td][/tr]
		// [tr][td]Palomera Blanes[/td][td]C.F. Hippycat[/td][td]2-0[/td][/tr]
		// [tr][td]Birrero Sabadell[/td][td]Angelets de la Terra[/td][td]0-6[/td][/tr]
		// [/table]

	}

	function csvToArray(text) {
		let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
		for (l of text) {
			if ('"' === l) {
				if (s && l === p) row[i] += l;
				s = !s;
			} else if (',' === l && s) l = row[++i] = '';
			else if ('\n' === l && s) {
				if ('\r' === p) row[i] = row[i].slice(0, -1);
				row = ret[++r] = [l = '']; i = 0;
			} else row[i] += l;
			p = l;
		}
		return ret;
	};

	function loadData() {

		document.getElementById("info").innerHTML += "<br>Accessing url...";

		var docID = document.getElementById("doc_id").value;

		// var url = "https://docs.google.com/spreadsheets/d/1auP1O8DEJkCFXDN_-r13ieLFOLAmVbbWa8RSOpbPGrI/export?format=csv";
		var url = "https://docs.google.com/spreadsheets/d/" + docID + "/export?format=csv"
		document.getElementById("info").innerHTML += "<br>Pulling data from " + url;

		xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {

			console.log(xmlhttp);

			if(xmlhttp.readyState == 4 && xmlhttp.status==200){

				document.getElementById("info").innerHTML += "<br>Data pulled";
				var table_str = xmlhttp.responseText;
				console.log(table_str)

				document.getElementById("info").innerHTML += "<br>Parsing...";
				var table_arr = csvToArray(table_str)
				console.log(table_arr)

				document.getElementById("info").innerHTML += "<br>Creating HT table...";
				table_HT = arrayToHTtable(table_arr)
				console.log(table_HT)

				document.getElementById("info").innerHTML += "<br>Displaying...";
				document.getElementById("display").innerHTML = table_HT;
			}
			else {
				document.getElementById("info").innerHTML += "<br>Something went wrong";
			}
		};
		xmlhttp.open("GET",url,true);
		xmlhttp.send(null);
	}

</script>

<html>
	<head>
		<link rel="stylesheet" type= "text/css" href="styles.css">
	</head>
	<body>
		<div class="main_body">
			<div align="center">
				Eina per convertir un google sheet en una taula de Hattrick
				<br>

				<img src="instructions.png" alt="Instruccions">
				1. Assegurat que has compartit el document de forma publica.
				2. Agafa el nom del document de la url (eg: 1auP1O8DEJkCFXDN_-r13ieLFOLAmVbbWa8RSOpbPGrI) i posa'l aqui sota:
				3. Prem convertir i aprecia la magia.
			
				<table align="center" border="0" width="60%">
					<br>
					<input id="doc_id" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
					<button type="button"  onclick="loadData()">Convertir</button>

					<div id="display"></div>
					<hr>
					<div id="info">Info</div>
					<hr>
					<div id="HTtable"></div>

				</table>
			</div>
		</div>
	</body>
</html>
